/*
Program Name: File Picker
Program URI: http://code.google.com/p/file-picker/
Description: Display and choose files from your website.
Version: 1.0 build 20080915

Copyright (c) 2008 Hpyer (hpyer[at]yahoo.cn)
Dual licensed under the MIT (MIT-LICENSE.txt)
and GPL (GPL-LICENSE.txt) licenses.
*/

function do_complete(){var C="";var B=get_uri();var A=get_selected(true);C='{uri:"'+B+'", files:['+A+"]}";do_close(C)}function do_close(obj){if(typeof (obj)!="string"){obj=""}eval("window.opener."+FP_RETURN_VAR+"='"+obj+"';");window.close()}function get_uri(){var A;A=$.base64.decode($("#folders_tree").val());A=A=="/"?"":A;return FP_RETURN_URI+A}function get_selected(B){var A=$("li.selected");if(A.length==1){return B?'"'+A.text()+'"':A.text()}return $.map(A,function(C){return'"'+C.innerHTML+'"'}).join(", ")}function do_select(B,A){A=A||false;B.addClass("selected");$("#filename_box").val(A?get_selected():"")}function do_unselect(){$("li.selected").removeClass("selected");$("#filename_box").val("");do_hide_info()}function do_show_info(A){var B=$("#info_box").addClass("info_box").css("top",(A.pageY+10)+"px").css("left",(A.pageX+10)+"px").fadeIn("fast")}function do_hide_info(A){var B=$("#info_box").empty();if(!A){B.hide()}}function do_translate_options(){$("#folders_tree option").each(function(){$(this).text($.base64.decode($(this).text()))})}function do_up(){var A=$.base64.decode($("#folders_tree").val());var C=A.lastIndexOf("/");if(C<0||A=="/"){return false}var B=A.substr(0,C);B=(B=="")?"/":$.base64.encode(B);$("#folders_tree").val(B);get_list()}function do_dblclick(){if($(this).attr("ftype")=="folder"){var A=$.base64.decode($("#folders_tree").val());if(A!="/"){A+="/"}$("#folders_tree").val($.base64.encode(A+$(this).text()));get_list()}else{do_select($(this));do_complete()}}function do_click(A){do_hide_info();if(!FP_MULTI_SELECT){do_unselect()}if(FP_MULTI_SELECT&&$(this).attr("ftype")=="folder"){if(!A.shiftKey){FP_LAST_CLICK=$(this).attr("id")}if(A.ctrlKey){return false}var B=$("li.selected").removeClass("selected");if(B.length==1&&B.attr("id")==$(this).attr("id")){do_unselect();return false}do_select($(this))}else{if(A.ctrlKey){FP_LAST_CLICK=$(this).attr("id");$("li.selected[ftype=folder]").removeClass("selected");$(this).toggleClass("selected");$("#filename_box").val(get_selected())}else{if(FP_MULTI_SELECT&&A.shiftKey){}else{FP_LAST_CLICK=$(this).attr("id");var B=$("li.selected").removeClass("selected");if(B.length==1&&B.attr("id")==$(this).attr("id")){do_unselect();return false}do_select($(this),true)}}}if(A.shiftKey){if(!FP_LAST_CLICK){FP_LAST_CLICK=$(this).attr("id");do_select($(this))}else{do_unselect();var C=parseInt(FP_LAST_CLICK.split("_")[1]);var D=parseInt($(this).attr("id").split("_")[1]);if(C>D){$("#list > li").slice(D,C+1).each(function(){do_select($(this))})}else{$("#list > li").slice(C,D+1).each(function(){do_select($(this))})}}$("li.selected[ftype=folder]").removeClass("selected");$("#filename_box").val(get_selected())}get_info(A);return false}function get_info(A){do_hide_info(true);var B=$("li.selected");if(B.length==1){do_show_info(A);$("<img>").attr("id","info_loading_img").attr("src",$("#loading_img").attr("src")).appendTo("#info_box");$.ajax({data:{action:"info",dir:$("#folders_tree").val(),file:$.base64.encode(B.text())},success:function(D){$("#info_box").html($("<label></label>").attr("id","btn_close").text("X").click(function(){do_hide_info(false)}));var C=0;$.each(D,function(F,G){if($("#info_box").css("display")=="none"){return false}if(G.key=="preview"){var H=get_uri()+"/"+$.base64.decode(G.value);var E=$("<img>").attr("id","preview_img").attr("alt",G.trans).attr("src",H);E.click(function(){window.open(this.src,"_blank","")}).prependTo("#info_box")}else{if(F==0){G.value=$.base64.decode(G.value)}$("#info_box").append("<strong>"+G.trans+"</strong>:<br /> &nbsp; "+G.value+"<br />")}F++})}})}}function get_list(A){if(typeof (A)=="undefined"){A=true}window._FP_LAST_CLICK=null;do_hide_info();$("#loading_img").show();$("#list").empty();$("#filename_box").val("");$.ajax({cache:A,data:{action:"list",dir:$("#folders_tree").val(),filter:$("#filter_box").val()},success:function(B){$("#loading_img").hide();var C=[];$.each(B,function(E,F){F.name=$.base64.decode(F.name);var D=$("<li></li>").attr("id","item_"+E).attr("ftype",F.type).attr("title",F.name).html(F.name);D.addClass(F.type).bind("dblclick",do_dblclick).bind("click",do_click).appendTo("#list");if(F.type!="folder"){C.push(F.name)}});$("#filename_box").autocompleteArray(C,{onItemSelect:function(){$("li:not(li[ftyp:folder])").each(function(){if($(this).html()==$("#filename_box").val()){$(this).click();return false}})}});do_unselect()}})}function events_binder(){$("body").bind("selectstart",function(){return false});$("#file_picker_form").bind("submit",function(){return false});$("#list_box").bind("click",do_unselect);$("#folders_tree").bind("change",function(){get_list(true)});$("#btn_refresh").bind("click",function(){get_list(false)});$("#btn_up").bind("click",do_up);$("#btn_complete").bind("click",do_complete);$("#btn_cancel").bind("click",do_close);$("#info_box").ppdrag()};